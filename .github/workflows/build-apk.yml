name: ⚡ Ultra Fast Flutter APK Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 3  # Force fast build

    steps:
    - name: 🚀 Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # Shallow clone for speed

    - name: 🔥 Mega Cache Setup
      uses: actions/cache@v4
      id: mega-cache
      with:
        path: |
          ~/.flutter-sdk
          ~/.pub-cache
          ~/.gradle/caches
          build/
          .dart_tool/
        key: ultra-cache-${{ hashFiles('pubspec.lock') }}-v3
        restore-keys: |
          ultra-cache-${{ hashFiles('pubspec.lock') }}-
          ultra-cache-

    - name: ⚡ Lightning Flutter Setup
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true
        cache-key: flutter-3.24.0-ultra

    - name: 📦 Smart Dependency Install
      run: |
        if [ -f "pubspec.lock" ] && [ -d ".dart_tool" ]; then
          echo "🚀 Using cached dependencies"
        else
          flutter pub get --no-precompile --offline
        fi

    - name: 🏗️ Turbo APK Build
      run: |
        export TERM=xterm
        flutter --suppress-analytics \
          build apk \
          --release \
          --target-platform android-arm \
          --split-per-abi \
          --no-null-assertions \
          --no-track-widget-creation \
          --no-pub \
          --build-name=1.0 \
          --build-number=1 \
          --dart-define=BUILD_MODE=release \
          --dart-define=CI=true \
          --verbose

    - name: 📤 Instant Artifact Upload
      uses: actions/upload-artifact@v4
      with:
        name: ⚡ turbo-app-v7a
        path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
        retention-days: 1  # Reduce storage

    - name: 🎯 Build Success Notification
      if: success()
      run: |
        echo "✅ APK built in under 3 minutes!"
        echo "📱 Artifact ready for download"

  # Optional: Skip build if only docs changed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.filter.outputs.src }}
    steps:
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          src:
            - 'lib/**'
            - 'pubspec.yaml'
            - 'assets/**'
            - 'android/**'
            - 'ios/**'